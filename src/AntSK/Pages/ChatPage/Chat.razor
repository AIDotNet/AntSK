@namespace AntSK.Pages.ChatPage
@using AntSK.Domain.Repositories
@using AntSK.Models
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using AntSK.Pages.ChatPage.Components
@page "/Chat"
@page "/Chat/{AppId}"
@using AntSK.Services.Auth
@inherits AuthComponentBase

<GridRow Gutter="(16, 16)">
    <GridCol Span="14">
        <Card Class="chat-card">
            <TitleTemplate>
                <Icon Type="setting" /> 选择应用
                <Select DataSource="@_list"
                        @bind-Value="@AppId"
                        DefaultValue="@("lucy")"
                        ValueProperty="c=>c.Id"
                        LabelProperty="c=>c.Name"
                        Style="width:200px">
                </Select>
                <a href="@( NavigationManager.BaseUri + "openchat/" + AppId)" target="_blank">分享使用</a>
            </TitleTemplate>
            <Body>
                <div class="chat-card__content">
                    @if (!string.IsNullOrEmpty(AppId))
                    {
                        <Watermark Content="AntSK" Class="chat-card__watermark">
                            <ChatView AppId="@AppId" ShowTitle=false OnRelevantSources="OnRelevantSources"></ChatView>
                        </Watermark>
                    }
                </div>
            </Body>
        </Card>
    </GridCol>
    <GridCol Span="10">
        <Card Style="height: 75vh;overflow: auto;">
            <TitleTemplate>
                <Icon Type="search" /> 知识溯源
            </TitleTemplate>
            <Extra>

            </Extra>
            <Body>
                <AntList Bordered DataSource="@_relevantSources" Style="padding:10px;">
                    <ChildContent Context="item">
                        <span> <b>@item.SourceName </b>  </span>
                        <br />
                        <span>相似度：<Text Mark> @item.Relevance</Text></span>
                        @if (@item.RerankScore != 0)
                        {
                            <br />
                            <span> Rerank相关性：<Text Mark> @item.RerankScore</Text></span>
                        }
                        <Body>
                            @((MarkupString)(@item.Text))
                        </Body>
                    </ChildContent>
                </AntList>
            </Body>
        </Card>
    </GridCol>
</GridRow>

<style>
    .chat-card {
        height: 75vh;
        display: flex;
        flex-direction: column;
        overflow: visible;
        min-height: 0;
    }

    .chat-card .ant-card-body {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 5px;
        box-sizing: border-box;
    }

    .chat-card__content {
        position: relative;
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        width: 100%;
        min-height: 0;
    }

    .chat-card__watermark {
        flex: 1 1 auto;
        display: flex;
        width: 100%;
        height: 100%;
        min-height: 0;
    }

    .chat-card__watermark > * {
        flex: 1 1 auto;
        min-width: 0;
        height: 100%;
    }

    body {
        margin: 0;
        justify-content: center;
        align-items: flex-start;
        height: 100vh;
        overflow-y: hidden;
    }
</style>
@code {

}
